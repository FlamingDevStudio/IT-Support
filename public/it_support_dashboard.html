<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Support Dashboard - IT Support System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <ul>
                    <li><a href="#" onclick="showSection('accountSection')">Account</a></li>
                    <li><a href="#" onclick="showSection('ticketsSection')">Manage Tickets</a></li>
                    <li><a href="#" onclick="showSection('equipmentSection')">Manage Equipment</a></li>
                    <li><a href="#" onclick="showSection('knowledgeBaseSection')">Knowledge Base</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <h1>Welcome, <span id="username"></span>!</h1>
        
        <div id="accountSection" class="card hidden">
            <h2>Update Account Info</h2>
            <form id="updateAccountForm">
                <input type="text" id="newUsername" placeholder="New Username">
                <input type="password" id="newPassword" placeholder="New Password">
                <button type="submit" class="btn">Update Account</button>
            </form>
        </div>

        <div id="ticketsSection" class="card">
            <h2>Manage Tickets</h2>
            <div id="ticketsList"></div>
        </div>

        <div id="equipmentSection" class="card hidden">
            <h2>Manage Equipment</h2>
            <button onclick="showAddEquipmentForm()" class="btn">Add New Equipment</button>
            <div id="addEquipmentForm" class="hidden">
                <form id="equipmentForm">
                    <input type="text" id="equipmentName" placeholder="Equipment Name" required>
                    <textarea id="equipmentDescription" placeholder="Description" required></textarea>
                    <input type="number" id="equipmentStock" placeholder="Total Stock" required>
                    <button type="submit" class="btn">Add Equipment</button>
                </form>
            </div>
            <div id="equipmentList"></div>
        </div>

        <div id="knowledgeBaseSection" class="card hidden">
            <h2>Knowledge Base</h2>
            <button onclick="showAddArticleForm()" class="btn">Add New Article</button>
            <div id="addArticleForm" class="hidden">
                <form id="articleForm">
                    <input type="text" id="articleTitle" placeholder="Article Title" required>
                    <input type="text" id="articleCategory" placeholder="Category" required>
                    <textarea id="articleContent" placeholder="Article Content" required></textarea>
                    <button type="submit" class="btn">Add Article</button>
                </form>
            </div>
            <div id="knowledgeBaseList"></div>
        </div>
    </div>

    <script>
        // Fetch user info and update username
        fetch('/user_info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('username').textContent = data.username;
            })
            .catch(error => console.error('Error:', error));

        // Show section function
        function showSection(sectionId) {
            document.querySelectorAll('.card').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Update account info
        document.getElementById('updateAccountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            
            fetch('/update_user_info', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: newUsername, password: newPassword })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.message === "User info updated successfully.") {
                    document.getElementById('username').textContent = newUsername || document.getElementById('username').textContent;
                }
            })
            .catch(error => console.error('Error:', error));
        });

        // Load tickets
        function loadTickets() {
            fetch('/tickets')
                .then(response => response.json())
                .then(data => {
                    const ticketsList = document.getElementById('ticketsList');
                    ticketsList.innerHTML = '<table><tr><th>Title</th><th>Status</th><th>Priority</th><th>Category</th><th>Action</th></tr>';
                    data.tickets.forEach(ticket => {
                        ticketsList.innerHTML += `
                            <tr>
                                <td>${ticket.Title}</td>
                                <td>${ticket.Status}</td>
                                <td>${ticket.Priority}</td>
                                <td>${ticket.Category}</td>
                                <td><button onclick="editTicket(${ticket.TicketID})" class="btn btn-small">Edit</button></td>
                            </tr>
                        `;
                    });
                    ticketsList.innerHTML += '</table>';
                })
                .catch(error => console.error('Error:', error));
        }

        // Edit ticket function
        function editTicket(ticketId) {
            // Implement edit ticket functionality
            console.log('Editing ticket:', ticketId);
        }

        // Show add equipment form
        function showAddEquipmentForm() {
            document.getElementById('addEquipmentForm').classList.remove('hidden');
        }

        // Add new equipment
        document.getElementById('equipmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const equipmentData = {
                Name: document.getElementById('equipmentName').value,
                Description: document.getElementById('equipmentDescription').value,
                TotalStock: document.getElementById('equipmentStock').value
            };

            fetch('/add_equipment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(equipmentData)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadEquipment();
                document.getElementById('equipmentForm').reset();
                document.getElementById('addEquipmentForm').classList.add('hidden');
            })
            .catch(error => console.error('Error:', error));
        });

        // Load equipment
        function loadEquipment() {
            fetch('/equipment')
                .then(response => response.json())
                .then(data => {
                    const equipmentList = document.getElementById('equipmentList');
                    equipmentList.innerHTML = '<table><tr><th>Name</th><th>Description</th><th>Available</th><th>Total</th><th>Action</th></tr>';
                    data.forEach(item => {
                        equipmentList.innerHTML += `
                            <tr>
                                <td>${item.Name}</td>
                                <td>${item.Description}</td>
                                <td>${item.AvailableStock}</td>
                                <td>${item.TotalStock}</td>
                                <td><button onclick="editEquipment(${item.EquipmentID})" class="btn btn-small">Edit</button></td>
                            </tr>
                        `;
                    });
                    equipmentList.innerHTML += '</table>';
                })
                .catch(error => console.error('Error:', error));
        }

        // Edit equipment function
        function editEquipment(equipmentId) {
            // Implement edit equipment functionality
            console.log('Editing equipment:', equipmentId);
        }

        // Show add article form
        function showAddArticleForm() {
            document.getElementById('addArticleForm').classList.remove('hidden');
        }

        // Add new knowledge base article
        document.getElementById('articleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const articleData = {
                Title: document.getElementById('articleTitle').value,
                Category: document.getElementById('articleCategory').value,
                Content: document.getElementById('articleContent').value
            };

            fetch('/add_article', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(articleData)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadKnowledgeBase();
                document.getElementById('articleForm').reset();
                document.getElementById('addArticleForm').classList.add('hidden');
            })
            .catch(error => console.error('Error:', error));
        });

        // Load knowledge base
        function loadKnowledgeBase() {
            fetch('/knowledge_base')
                .then(response => response.json())
                .then(data => {
                    const knowledgeBaseList = document.getElementById('knowledgeBaseList');
                    knowledgeBaseList.innerHTML = '<table><tr><th>Title</th><th>Category</th><th>Action</th></tr>';
                    data.articles.forEach(article => {
                        knowledgeBaseList.innerHTML += `
                            <tr>
                                <td>${article.Title}</td>
                                <td>${article.Category}</td>
                                <td>
                                    <button onclick="viewArticle(${article.ArticleID})" class="btn btn-small">View</button>
                                    <button onclick="editArticle(${article.ArticleID})" class="btn btn-small">Edit</button>
                                </td>
                            </tr>
                        `;
                    });
                    knowledgeBaseList.innerHTML += '</table>';
                })
                .catch(error => console.error('Error:', error));
        }

        // View knowledge base article
        function viewArticle(articleId) {
            fetch(`/knowledge_base/${articleId}`)
                .then(response => response.json())
                .then(article => {
                    alert(`Title: ${article.Title}\n\nCategory: ${article.Category}\n\nContent: ${article.Content}`);
                })
                .catch(error => console.error('Error:', error));
        }

        // Edit knowledge base article
        function editArticle(articleId) {
            // Implement edit article functionality
            console.log('Editing article:', articleId);
        }

        // Logout function
        function logout() {
            fetch('/logout', { method: 'POST' })
                .then(() => window.location.href = '/login.html')
                .catch(error => console.error('Error:', error));
        }

        // Initial load
        loadTickets();
        loadEquipment();
        loadKnowledgeBase();
    </script>
</body>
</html>